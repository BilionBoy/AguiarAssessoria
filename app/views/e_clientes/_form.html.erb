<%= simple_form_for @e_cliente, html: { class: "modern-form" }, data: { turbo: false } do |f| %>
  <% if @e_cliente.errors.any? %>
    <div class="alert alert-danger" style="margin-bottom: 24px;">
      <strong><%= pluralize(@e_cliente.errors.count, "erro") %> encontrados:</strong>
      <ul>
        <% @e_cliente.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div class="form-wizard">
    <!-- HEADER -->
    <div class="wizard-header">
      <div class="wizard-steps">
        <div class="wizard-step active" data-step="1"><span>1</span> Dados Cadastrais</div>
        <div class="wizard-step" data-step="2"><span>2</span> Dados Funcionais</div>
        <div class="wizard-step" data-step="3"><span>3</span> Documentos</div>
      </div>
      <div class="wizard-progress">
        <div class="wizard-progress-bar"></div>
      </div>
    </div>
    <!-- STEP 1 -->
    <div class="wizard-step-content" id="step1">
      <h3>üìã Dados Cadastrais</h3>
      <div class="form-grid">
        <!-- Identifica√ß√£o -->
        <%= f.input :nome_completo, placeholder: "Nome completo" %>
        <%= f.input :nome_social, placeholder: "Nome social" %>
        <%= f.input :cpf, label: "CPF", input_html: { maxlength: 11, placeholder: "Somente n√∫meros" } %>
        <!-- Sexo + Nascimento -->
        <%= f.association :g_sexo,
              collection: GSexo.all,
              label_method: :descricao,
              value_method: :id,
              prompt: "Selecione o sexo" %>
        <%= f.input :data_nascimento,
              as: :date,
              start_year: 1900,
              end_year: Date.today.year,
              order: [:day, :month, :year],
              label: "Data de nascimento" %>
        <!-- Localiza√ß√£o -->
        <%= f.input :g_estado_id,
              collection: GEstado.all,
              label_method: :nome_fantasia,
              value_method: :id,
              prompt: "Selecione o estado" %>
        <%= f.input :g_cidade_id,
              collection: GCidade.all,
              label_method: :nome_fantasia,
              value_method: :id,
              prompt: "Selecione a cidade" %>
        <%= f.input :g_bairro_id,
              collection: GBairro.all,
              label_method: :descricao,
              value_method: :id,
              prompt: "Selecione o bairro" %>
        <!-- Contato -->
        <%= f.input :email, placeholder: "Email" %>
        <%= f.input :telefone,
              label: "Telefone",
              input_html: { placeholder: "(99) 99999-9999" } %>
        <div style="grid-column: span 1;">
          <%= f.input :agencia, placeholder: "Ag√™ncia banc√°ria" %>
        </div>
        <div style="grid-column: span 1;">
          <%= f.input :conta, placeholder: "Conta banc√°ria" %>
        </div>
        <div style="grid-column: 1 / -1;">
          <%= f.input :endereco, placeholder: "Endere√ßo completo" %>
        </div>
      </div>
    </div>
    <!-- STEP 2 -->
    <div class="wizard-step-content" id="step2" style="display:none;">
      <h3>‚öôÔ∏è Dados Funcionais</h3>
      <div class="form-grid">
        <%= f.input :matricula, placeholder: "Matr√≠cula" %>
        <%= f.input :g_orgao_id,
              collection: GOrgao.all,
              label_method: :descricao,
              value_method: :id,
              prompt: "Selecione o √≥rg√£o",
              input_html: { id: "g_orgao_select" } %>
        <%= f.input :alfabetizado, as: :boolean, label: "Alfabetizado?" %>
        <%= f.input :ultima_margem, placeholder: "√öltima margem" %>
        <%= f.input :data_ultima_margem, as: :date, label: "Data √∫ltima margem" %>
        <!-- Condicionais ESTADO -->
        <div id="estado_fields" style="display:none;">
          <%= f.input :ano_admissao, placeholder: "Ano de admiss√£o" %>
          <%= f.input :pensionista, as: :boolean, label: "Pensionista?" %>
        </div>
        <!-- Condicionais INSS -->
        <div id="inss_fields" style="display:none;">
          <%= f.input :numero_beneficio, placeholder: "N√∫mero do benef√≠cio" %>
          <%= f.input :g_tipo_beneficio_id,
                collection: GTipoBeneficio.all,
                label_method: :descricao,
                value_method: :id,
                prompt: "Tipo de benef√≠cio" %>
          <%= f.input :possui_representante_legal, as: :boolean, label: "Possui representante legal?" %>
        </div>
      </div>
    </div>
    <!-- STEP 3 -->
    <div class="wizard-step-content" id="step3" style="display:none;">
      <h3>üìé Documentos</h3>
      <div class="form-grid">
        <%= f.input :foto_cliente, as: :file, label: "Foto do cliente" %>
        <%= f.input :foto_contracheque, as: :file, label: "Contracheque" %>
        <%= f.input :foto_rg, as: :file, label: "Documento RG" %>
      </div>
    </div>
    <!-- ACTIONS -->
    <div class="wizard-actions justify-content-end gap-2">
      <button type="button" id="prevBtn">‚¨Ö Anterior</button>
      <div>
        <%= link_to "Cancelar", e_clientes_path, class: "btn btn-light" %>
        <button type="button" id="nextBtn">Pr√≥ximo ‚û°</button>
        <%= f.submit "Salvar Cliente", id: "submitBtn", style: "display:none;" %>
      </div>
    </div>
  </div>
<% end %>
<!-- STYLE -->
<style>
  .form-wizard { display:flex; flex-direction:column; gap:24px; }
  .wizard-header { background:#fff; padding:24px; border-radius:12px; }
  .wizard-steps { display:flex; justify-content:space-between; }
  .wizard-step { flex:1; text-align:center; cursor:pointer; color:#9ca3af; }
  .wizard-step span { display:block; width:36px; height:36px; margin:0 auto 6px; border-radius:50%; background:#e5e7eb; line-height:36px; }
  .wizard-step.active span { background:#2563eb; color:#fff; }
  .wizard-progress { height:4px; background:#e5e7eb; border-radius:2px; overflow:hidden; margin-top:12px; }
  .wizard-progress-bar { height:100%; width:0%; background:#2563eb; transition:0.3s; }

  .wizard-step-content { background:#fff; padding:32px; border-radius:12px; }
  .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; }

  .wizard-actions { display:flex; justify-content:space-between; background:#fff; padding:20px; border-radius:12px; }

  button { padding:10px 18px; border-radius:8px; border:none; cursor:pointer; }
  #nextBtn { background:#2563eb; color:white; }
  #prevBtn { background:#e5e7eb; }
  #submitBtn { background:#10b981; color:white; }
  .btn-cancel { margin-right:10px; text-decoration:none; }
</style>
<!-- SCRIPT -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    let currentStep = 1;
    const totalSteps = 3;

    const steps = document.querySelectorAll(".wizard-step");
    const contents = document.querySelectorAll(".wizard-step-content");
    const progress = document.querySelector(".wizard-progress-bar");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    function showStep(step){
      contents.forEach((c,i)=> c.style.display = (i+1 === step ? "block" : "none"));
      steps.forEach((s,i)=> s.classList.toggle("active", i+1 === step));
      progress.style.width = ((step-1)/(totalSteps-1))*100 + "%";
      prevBtn.style.display = step === 1 ? "none" : "inline-block";
      nextBtn.style.display = step === totalSteps ? "none" : "inline-block";
      submitBtn.style.display = step === totalSteps ? "inline-block" : "none";
    }

    nextBtn.onclick = () => { if(currentStep < totalSteps){ currentStep++; showStep(currentStep); } };
    prevBtn.onclick = () => { if(currentStep > 1){ currentStep--; showStep(currentStep); } };

    showStep(currentStep);

    // Condicionais √≥rg√£o
    const orgao = document.getElementById("g_orgao_select");
    const estado = document.getElementById("estado_fields");
    const inss = document.getElementById("inss_fields");

    function toggleCampos(){
      const text = orgao?.selectedOptions[0]?.text?.toLowerCase() || "";
      estado.style.display = text.includes("estado") ? "block" : "none";
      inss.style.display   = text.includes("inss")   ? "block" : "none";
    }

    orgao?.addEventListener("change", toggleCampos);
    toggleCampos();

  });
</script>
